#!/usr/bin/env bash
# init
# Initialize this repo after cloning:
# - rename directory "bash-scripts" -> "scripts" (if applicable)
# - ensure $HOME/scripts exists and is added to PATH via ~/.bashrc (appended)
# - copy .aliases to $HOME/.aliases
# - append lines to ~/.bashrc to source ~/.aliases and add $HOME/scripts to PATH (if not already present)
# - source ~/.bashrc in the current shell and show loaded aliases
# - prompt (read -n 1) to run fixnano (enables nano mouse support and common key bindings)
set -euo pipefail

info() { printf "\033[1;34m==> %s\033[0m\n" "$*"; }
warn() { printf "\033[1;33m!! %s\033[0m\n" "$*"; }
err() { printf "\033[1;31mERROR: %s\033[0m\n" "$*"; }

# 1) Rename directory if needed
CUR="$(pwd -P)"
BASENAME="$(basename "$CUR")"
if [ "$BASENAME" = "bash-scripts" ]; then
  PARENT="$(dirname "$CUR")"
  TARGET="$PARENT/scripts"
  if [ -e "$TARGET" ]; then
    warn "Target directory $TARGET already exists; skipping rename."
  else
    info "Renaming '$CUR' -> '$TARGET'"
    mv "$CUR" "$TARGET"
    cd "$TARGET"
    info "Now in $(pwd -P)"
  fi
else
  info "Current directory name is '$BASENAME' (no rename needed)."
fi

# 2) Ensure $HOME/scripts exists
HOME_SCRIPTS="$HOME/scripts"
if [ ! -d "$HOME_SCRIPTS" ]; then
  info "Creating $HOME_SCRIPTS"
  mkdir -p "$HOME_SCRIPTS"
else
  info "$HOME_SCRIPTS already exists"
fi

# 3) Backup existing ~/.bashrc (if any) before appending
BASHRC="$HOME/.bashrc"
if [ -f "$BASHRC" ]; then
  BACKUP="$BASHRC.bak.$(date +%Y%m%d%H%M%S)"
  info "Backing up existing $BASHRC -> $BACKUP"
  cp -a "$BASHRC" "$BACKUP"
else
  info "No existing $BASHRC found; creating one via append operations."
  touch "$BASHRC"
fi

# 4) Copy .aliases to $HOME
if [ -f "./.aliases" ]; then
  info "Copying .aliases to $HOME/.aliases"
  cp -f "./.aliases" "$HOME/.aliases"
else
  warn "No .aliases found in repo root; skipping copy."
fi

# 5) Append PATH and source lines to ~/.bashrc if they're not already present
GREPPATHLINE='export PATH="$HOME/scripts:$PATH"'
GREPALIASLINE='source "$HOME/.aliases"'

# Use grep -F to match literal lines
if ! grep -Fq 'export PATH="$HOME/scripts:$PATH"' "$BASHRC"; then
  info "Appending PATH addition to $BASHRC"
  printf "\n# Added by init script: ensure user's scripts directory is first in PATH\nexport PATH=\"$HOME/scripts:$PATH\"\n" >> "$BASHRC"
else
  info "PATH addition already present in $BASHRC"
fi

if ! grep -Fq 'source "$HOME/.aliases"' "$BASHRC"; then
  info "Appending source of ~/.aliases to $BASHRC"
  printf "\n# Added by init script: source user's aliases if present\nif [ -f \"$HOME/.aliases\" ]; then\n  source \"$HOME/.aliases\"\nfi\n" >> "$BASHRC"
else
  info "Aliases source already present in $BASHRC"
fi

# 6) Source the updated ~/.bashrc in the current shell
# shellcheck disable=SC1090
if [ -f "$BASHRC" ]; then
  info "Sourcing $BASHRC"
  # shellcheck disable=SC1090
  source "$BASHRC" || true
  info "Sourced $BASHRC. Current PATH begins with: $(echo "$PATH" | awk -F: '{print $1}')"
else
  warn "$BASHRC not found to source"
fi

# 7) Show loaded aliases (if any)
info "Loaded aliases (if available):"
alias || true

# 8) Prompt to run fixnano
printf "\n\033[1mfixnano\033[0m: Configure nano to enable mouse support and useful key bindings (improves terminal editing).\n"
read -n 1 -r -p "Run fixnano now? [y/N] " ANSWER
printf "\n"
if [[ "$ANSWER" =~ ^[Yy]$ ]]; then
  if [ -f "./fixnano.sh" ]; then
    info "Running local ./fixnano.sh"
    bash ./fixnano.sh
  else
    info "Local fixnano.sh not found; downloading and running the version from the repository"
    RAW_URL="https://raw.githubusercontent.com/don-ferris/bash-scripts/main/fixnano.sh"
    TMP="$(mktemp)"
    if command -v curl >/dev/null 2>&1; then
      curl -fsSL "$RAW_URL" -o "$TMP"
    else
      wget -qO "$TMP" "$RAW_URL"
    fi
    bash "$TMP"
    rm -f "$TMP"
  fi
else
  info "Skipping fixnano."
fi

info "Initialization complete. Open a new terminal to ensure PATH and aliases are applied persistently."