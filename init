#!/usr/bin/env bash
# init - Post-clone setup: create/rename scripts dir, install .aliases, and update ~/.bashrc (optionally runs fixnano).
# ──────────────────────────────────────────────────────
# Author: Don Ferris
# Created: [20-10-2025]
# Current Revision: v1.0
# ──────────────────────────────────────────────────────
# Revision History
# ----------------
# v1.0 — 2025-10-24 — Core functionality
######## ########

set -euo pipefail

# Lockfile setup to prevent multiple simultaneous runs
LOCKFILE="/tmp/init-script.lock"

# Remove lock on exit or termination
cleanup() {
    if rm -f "$LOCKFILE"; then
        info "Cleaning up lockfile: $LOCKFILE"
    fi
}
trap cleanup EXIT INT TERM

# Acquire lock
if ! (set -o noclobber; > "$LOCKFILE") 2>/dev/null; then
    err "Script is already running. If this is an error, delete $LOCKFILE"
    exit 1
fi
# Store PID in lockfile for debugging
echo $$ > "$LOCKFILE"
info "Acquired lock: $LOCKFILE"

info() { printf "\033[1;34m==> %s\033[0m\n" "$*"; }
warn() { printf "\033[1;33m!! %s\033[0m\n" "$*"; }
err() { printf "\033[1;31mERROR: %s\033[0m\n" "$*"; }

# Install ntfy via Official Repository
install_ntfy() {
    local NTFY_DEB_ARCH="amd64"  # Change to "arm64" or "armhf" if on ARM

    if ! command -v ntfy >/dev/null 2>&1; then
        info "Installing ntfy..."

        # Add the repository and key (method for newer Debian/Ubuntu)
        sudo mkdir -p /etc/apt/keyrings
        sudo curl -fsSL -o /etc/apt/keyrings/ntfy.gpg https://archive.ntfy.sh/apt/keyring.gpg
        echo "deb [arch=${NTFY_DEB_ARCH} signed-by=/etc/apt/keyrings/ntfy.gpg] https://archive.ntfy.sh/apt stable main" | sudo tee /etc/apt/sources.list.d/ntfy.list >/dev/null

        sudo apt update
        sudo apt install -y ntfy
        info "ntfy installed successfully."
    else
        info "ntfy is already installed."
    fi
}

# Test ntfy installation and provide usage instructions
test_ntfy() {
    info "Testing ntfy installation..."
    if ntfy send "MediaSync: Test notification from init script" 2>/dev/null; then
        info "ntfy test notification sent successfully"
    else
        warn "ntfy test failed - may need manual configuration"
        printf "\n\033[1mNTFY CONFIGURATION REQUIRED:\033[0m\n"
        printf "To use ntfy for notifications, you may need to:\n"
        printf "1. Start the service: sudo systemctl start ntfy\n"
        printf "2. Enable on boot: sudo systemctl enable ntfy\n"
        printf "3. Check status: sudo systemctl status ntfy\n"
        printf "4. Configure server: edit /etc/ntfy/server.yml\n"
        printf "5. For public ntfy.sh, use: ntfy publish your-topic 'message'\n"
        printf "\nUsage examples:\n"
        printf "  ntfy send 'Hello World'\n"
        printf "  ntfy publish mytopic 'Message with topic'\n"
        printf "  echo 'Message' | ntfy send\n"
        printf "\nSee: ntfy --help for more options\n\n"
    fi
}

# 1) Rename directory if needed
CUR="$(pwd -P)"
BASENAME="$(basename "$CUR")"
if [ "$BASENAME" = "bash-scripts" ]; then
  PARENT="$(dirname "$CUR")"
  TARGET="$PARENT/scripts"
  if [ -e "$TARGET" ]; then
    warn "Target directory $TARGET already exists; skipping rename."
  else
    info "Renaming '$CUR' -> '$TARGET'"
    mv "$CUR" "$TARGET"
    cd "$TARGET"
    info "Now in $(pwd -P)"
  fi
else
  info "Current directory name is '$BASENAME' (no rename needed)."
fi

# 2) Ensure $HOME/scripts exists
HOME_SCRIPTS="$HOME/scripts"
if [ ! -d "$HOME_SCRIPTS" ]; then
  info "Creating $HOME_SCRIPTS"
  mkdir -p "$HOME_SCRIPTS"
else
  info "$HOME_SCRIPTS already exists"
fi

# 3) Backup existing ~/.bashrc (if any) before appending
BASHRC="$HOME/.bashrc"
if [ -f "$BASHRC" ]; then
  BACKUP="$BASHRC.bak.$(date +%Y%m%d%H%M%S)"
  info "Backing up existing $BASHRC -> $BACKUP"
  cp -a "$BASHRC" "$BACKUP"
else
  info "No existing $BASHRC found; creating one via append operations."
  touch "$BASHRC"
fi

# 4) Copy .aliases to $HOME
if [ -f "./.aliases" ]; then
  info "Copying .aliases to $HOME/.aliases"
  cp -f "./.aliases" "$HOME/.aliases"
else
  warn "No .aliases found in repo root; skipping copy."
fi

# 5) Append PATH and source lines to ~/.bashrc if they're not already present
GREPPATHLINE='export PATH="$HOME/scripts:$PATH"'
GREPALIASLINE='source "$HOME/.aliases"'

# Use grep -F to match literal lines
if ! grep -Fq 'export PATH="$HOME/scripts:$PATH"' "$BASHRC"; then
  info "Appending PATH addition to $BASHRC"
  printf "\n# Added by init script: ensure user's scripts directory is first in PATH\nexport PATH=\"$HOME/scripts:$PATH\"\n" >> "$BASHRC"
else
  info "PATH addition already present in $BASHRC"
fi

if ! grep -Fq 'source "$HOME/.aliases"' "$BASHRC"; then
  info "Appending source of ~/.aliases to $BASHRC"
  printf "\n# Added by init script: source user's aliases if present\nif [ -f \"$HOME/.aliases\" ]; then\n  source \"$HOME/.aliases\"\nfi\n" >> "$BASHRC"
else
  info "Aliases source already present in $BASHRC"
fi

# 6) Source the updated ~/.bashrc in the current shell
# shellcheck disable=SC1090
if [ -f "$BASHRC" ]; then
  info "Sourcing $BASHRC"
  # shellcheck disable=SC1090
  source "$BASHRC" || true
  info "Sourced $BASHRC. Current PATH begins with: $(echo "$PATH" | awk -F: '{print $1}')"
else
  warn "$BASHRC not found to source"
fi

# 7) Show loaded aliases (if any)
info "Loaded aliases (if available):"
alias || true

# 8) Install ntfy
install_ntfy

# 9) Test ntfy and provide configuration instructions
test_ntfy

# 10) Prompt to run fixnano
printf "\n\033[1mfixnano\033[0m: Configure nano to enable mouse support and useful key bindings (improves terminal editing).\n"
read -n 1 -r -p "Run fixnano now? [y/N] " ANSWER
printf "\n"
if [[ "$ANSWER" =~ ^[Yy]$ ]]; then
  if [ -f "./fixnano.sh" ]; then
    info "Running local ./fixnano.sh"
    bash ./fixnano.sh
  else
    info "Local fixnano.sh not found; downloading and running the version from the repository"
    RAW_URL="https://raw.githubusercontent.com/don-ferris/bash-scripts/main/fixnano.sh"
    TMP="$(mktemp)"
    if command -v curl >/dev/null 2>&1; then
      curl -fsSL "$RAW_URL" -o "$TMP"
    else
      wget -qO "$TMP" "$RAW_URL"
    fi
    bash "$TMP"
    rm -f "$TMP"
  fi
else
  info "Skipping fixnano."
fi

info "Initialization complete. Open a new terminal to ensure PATH and aliases are applied persistently."
